<!doctype html>
<html>
  <head>
  <style>
  html body {
    z-index: 0;
    width: 100%;
    height: 100%;
  }
  body {
    background-color: #c0c0c0;
    font-family: arial;
  }
  #link_stream_div {
    position: absolute;
    display: table-cell;
  }
  #button_charts{
  }
  #parameters {
    position: relative;
    left:20px;
    top:20px;
    vertical-align: center;
    display: table-cell;
    visibility: hidden;
  }
  #canvas_1 {
    float: left;
    clear: left;
    vertical-align: center;
  }
  #textarea_1 {
    resize: vertical;
    float: left;
    clear: left;
    vertical-align: center;
  }
  #textarea_2 {
    resize: vertical;
    float: left;
    clear: left;
    vertical-align: center;
  }
  #compteur_lignes {
    text-align:right;
    resize: none;
    float: left;
    clear: left;
    vertical-align: center;
  }
  </style>


  <title>TEMPORAL MATCHING IN LINK STREAMS</title>
  </head>


  <body>
    <div id="link_stream_div">
      <div id="button_charts">
        <button id="button_pause" title="Play/Pause" onclick="pause_loop()"> &#10074;&#10074; &#9658; </button>
        <button id="button_parameters" title="Personalize parameters" onclick="display_or_not()">&#9881;</button>
        <button id="button_quicker" title="Slower" onclick="slower()">&#9194;</button>
        <button id="button_slower" title="Faster" onclick="faster()">&#9193;</button>
      </div>
      <canvas id="canvas_1" title="link stream canvas" width="321" height="321" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ng-model-options="{ updateOn: 'blur' }"></canvas>
      <textarea id="compteur_lignes" cols="50"  rows="1"></textarea>
      <textarea id="textarea_1" title="result1" cols="50" rows="3"></textarea>
      <textarea id="textarea_2" title="result2" cols="50" rows="3"></textarea>
    </div>
    <form id="parameters" width="321" >
      <font size="2">
        <input id="teams_value" type="number" title="The number of teams" value="5" width="#Teams">
        <label for="teams_value">#Teams</br></label>      
        <input id="disksteam_value" type="number" title="The number of disks in each team" value ="3" width="#Disks/Team">
        <label for="disksteam_value">#Disks/Team</br></label>
        <input id="gamma_value" type="number" title="The value of gamma" value="7" width="Gamma">
        <label for="gamma_value">Gamma</br></label>
        <input id="rayon_value" type="number" title="The rayon of disks" value="12" width="Rayon">   
        <label for="rayon_value">Rayon</br></label>               
        <input id="max_veloc_value" type="number" title="The maximum velocity of disks" value="3" width="Maximum Velocity">
        <label for="max_veloc_value">Max velocity</br></label>    
        <input id="max_acc_value" type="number" title="The maximum acceleration of disks" value="0.8" width="">
        <label for="max_acc_value">Max acceleration</br></label>
        <button id="button_launch" title="Restart with new parameters" onclick="launch()">&#8634;</button>
      </font>
    </form>
    

  <script src="index.js"></script>

  <script type="text/javascript">


    var gamma;
    var nombre_equipes;
    var nombre_joueurs_par_equipe;
    var rayon;
    var vitesse_max;
    var acceleration_max;
    var equipes = [];
    var couleurs_equipes = [];
    var gamma_collisions = [];
    var gamma_array = [];
    var nombre_lignes = 0;
    var nombre_gamma_aretes = 0;

    var rollernet_canvas;
    var canvas_window;
    var largeur;
    var hauteur;
    var menu_deroulant = document.getElementById("parameters");
    var textarea_link_stream = document.getElementById("textarea_1");
    var textarea_gamma_aretes = document.getElementById("textarea_2");
    var textarea_compteur_lignes = document.getElementById("compteur_lignes");
    var bouton_pause = document.getElementById("button_pause");
    var text_collisions = "";
    var text_collisions_last_tick = "";
    var text_gamma_aretes = "";
    var text_gamma_aretes_last_tick = "";
    var SQRT_2 = Math.sqrt(2);

    var wait_time_ms = 1000. / 60.;
    var tick = 0;
    var d = new Date();
    var time = d.getTime();

    var pause = true;

    function launch(){
      pause = false;
      tick = 0;
      nombre_lignes = 0;
      nombre_gamma_aretes = 0;
      text_collisions = "";
      text_gamma_aretes = "";
      gamma_collisions = [];
      gamma_array = [];
      gamma = parseInt(document.getElementById("gamma_value").value);
      nombre_equipes = parseInt(document.getElementById("teams_value").value);
      nombre_joueurs_par_equipe = parseInt(document.getElementById("disksteam_value").value);
      rayon = parseInt(document.getElementById("rayon_value").value);
      vitesse_max = parseFloat(document.getElementById("max_veloc_value").value);
      acceleration_max = parseFloat(document.getElementById("max_acc_value").value);
      init();
    }



    


    var init = function(){
      text_collisions = "";
      text_gamma_aretes = "";
      nombre_lignes = 0;
      nombre_gamma_aretes = 0;
      rollernet_canvas = document.getElementById("canvas_1");
      canvas_window = rollernet_canvas.getContext("2d");
      largeur = rollernet_canvas.width;
      hauteur = rollernet_canvas.height;
      SQRT_2 = Math.sqrt(2);
      for (var i = 0; i < nombre_equipes; i++){
            equipes[i] = [];
            couleurs_equipes[i] = 'rgba(' + 
                                    parseInt(Math.random() * 256) + ',' + 
                                    parseInt(Math.random() * 256) + ',' + 
                                    parseInt(Math.random() * 256) + ',' +
                                    '0.5)';

            for (var j = 0; j < nombre_joueurs_par_equipe; j++){
              var x = rollernet_canvas.width * Math.random();
              var y = rollernet_canvas.height * Math.random();
              var dx = (SQRT_2 - Math.random() * 2 * SQRT_2) * vitesse_max;
              var dy = (SQRT_2 - Math.random() * 2 * SQRT_2) * vitesse_max;
              var couleur = couleurs_equipes[i];
              var nouveau_roller = {equipe:i, numero:j, x:x, y:y, dx:dx, dy:dy, rayon:rayon, couleur:couleur};
              equipes[i][j] = nouveau_roller;
            }
            gamma_array[i] = [];
            for (var j = 0; j < nombre_equipes; j++){
              gamma_array[i][j] = 0;
            }
      }
    }
    var loop = function (){
        if (!pause){
          fps = (d.getTime() - time);
          clear_canvas();
          for (var i = 0; i < nombre_equipes; i++){
            for (var j = 0; j < nombre_joueurs_par_equipe; j++){
              update_roller(equipes[i][j]);
            }
          }
          var collisions_array = collisions();
          for (var i = 0; i < nombre_equipes; i++){
            for (var j = 0; j < nombre_joueurs_par_equipe; j++){
              draw_roller(equipes[i][j]);
            }
          }
          draw_collisions(collisions_array);
          refreshText();
          tick++;
          time = d.getTime();
        }
        setTimeout(function() {requestAnimationFrame(loop)}, wait_time_ms);
    }

    var stop_loop = function(){
      loop_stoped = true;
    }

    var collisions = function(){
      var collisions_array = [];
      text_collisions_last_tick = "";
      text_gamma_aretes_last_tick = "";
      for (var i = 0; i < nombre_equipes; i++){
        for (var j = i + 1; j < nombre_equipes; j++){
          var collision_equipe_i_j = false;

          for (var ii = 0; ii < nombre_joueurs_par_equipe; ii++){
            for (var jj = 0; jj < nombre_joueurs_par_equipe; jj++){
              var dist_j0_j_1 = dist(equipes[i][ii].x, equipes[i][ii].y, equipes[j][jj].x, equipes[j][jj].y);
              if (dist_j0_j_1 < equipes[i][ii].rayon + equipes[j][jj].rayon){
                var nouvelle_collision = [equipes[i][ii], equipes[j][jj]];
                collision_equipe_i_j = true;
                collisions_array.push([equipes[i][ii], equipes[j][jj]]);
                text_collisions_last_tick += i + " " + j + " " + tick + "\n";
                nombre_lignes++;
                break;
              }
            }
          }
          if (collision_equipe_i_j){
            gamma_array[i][j]++;
            if (gamma_array[i][j] >= gamma){
              gamma_collisions.push([i,j,tick-gamma+1]);
              text_gamma_aretes_last_tick += i + " " + j + " " + (tick-gamma+1) + "\n";
              nombre_gamma_aretes++;
            }
          }
          else{
            gamma_array[i][j] = 0;
          }  
        }
      }
      text_collisions += text_collisions_last_tick;
      text_gamma_aretes += text_gamma_aretes_last_tick;
      return collisions_array;
    }
    var draw_roller = function(roller){
      canvas_window.fillStyle = roller.couleur;
      drawEllipseByCenter(canvas_window,roller.x,roller.y,rayon*2,rayon*2);
   //   canvas_window.strokeText(roller.numero+"",roller.x,roller.y);
    }
    var draw_collisions = function(collisions_array, new_gamma_collisions){
      for (var i = 0; i < collisions_array.length; i++){
        draw_collision(collisions_array[i][0],collisions_array[i][1]);
      }
      if (collisions_array.length > 0){
        text_collisions += "\n";
      }
    }
    var draw_collision = function (roller_1, roller_2){
        canvas_window.fillStyle = 0x000000;
        canvas_window.beginPath();
        canvas_window.moveTo(roller_1.x, roller_1.y);
        canvas_window.lineTo(roller_2.x, roller_2.y);
        canvas_window.stroke();
    }
    var clear_canvas = function(){
      canvas_window.fillStyle = 'rgba(255,255,255,1)';
      canvas_window.fillRect( 0,0,largeur,hauteur);
  }
    var update_roller = function (roller) {
      var acc_x = (Math.random() - 1. / 2.) * 2 * acceleration_max;
      var acc_y = (Math.random() - 1. / 2.) * 2 * acceleration_max;
      var acc = dist(0,0,acc_x, acc_y);
      roller.dx += acc_x;
      roller.dy += acc_y;
      var vit = dist(0,0,roller.dx, roller.dy);
      if (vit > vitesse_max){
        roller.dx *= vitesse_max / vit;
        roller.dy *= vitesse_max / vit;
      }
      roller.x += roller.dx;
      roller.y += roller.dy;
      if (roller.x < 0){
        roller.x = largeur - 1;
      }
      if (roller.x >= largeur){
        roller.x = 0;
      }
      if (roller.y < 0){
        roller.y = hauteur - 1;
      }
      if (roller.y >= hauteur){
        roller.y = 0;
      }
    };
    var dist = function (x_1, y_1, x_2, y_2){
      return Math.sqrt(dist_squared(x_1, y_1, x_2, y_2));
    }
    var dist_squared = function (x_1, y_1, x_2, y_2){
      return (x_1-x_2)*(x_1-x_2)+(y_1-y_2)*(y_1-y_2);
    }
    function drawEllipseByCenter(ctx, cx, cy, w, h) {
      drawEllipse(ctx, cx - w/2.0, cy - h/2.0, w, h);
    }

    function drawEllipse(ctx, x, y, w, h) {
      var kappa = .5522848,
          ox = (w / 2) * kappa, // control point offset horizontal
          oy = (h / 2) * kappa, // control point offset vertical
          xe = x + w,           // x-end
          ye = y + h,           // y-end
          xm = x + w / 2,       // x-middle
          ym = y + h / 2;       // y-middle

      ctx.beginPath();
      ctx.moveTo(x, ym);
      ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
      ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
      ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
      ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
      ctx.fill();
      ctx.strokeStyle = 0x000000;
      ctx.stroke();
    }

    function refreshText() {
      //  textarea_link_stream.value = text_collisions;
        textarea_link_stream.value = text_collisions_last_tick;
        textarea_link_stream.scrollTop = textarea_link_stream.scrollHeight;
      //  textarea_gamma_aretes.value = text_gamma_aretes;
        textarea_gamma_aretes.value = text_gamma_aretes_last_tick;
        textarea_gamma_aretes.scrollTop = textarea_gamma_aretes.scrollHeight;
        textarea_compteur_lignes.value = tick + " ticks   " + nombre_lignes + " edges   " + nombre_gamma_aretes + " gamma-edges";
    }


    function display_or_not(){
      if (menu_deroulant.style.visibility == "visible"){
        menu_deroulant.style.visibility = "hidden";
      }
      else{
        menu_deroulant.style.visibility = "visible";
      }
    }

    function pause_loop(){
      pause = !pause;
    }

    function slower(){
      wait_time_ms *= 1.1;
    }
    function faster(){
      wait_time_ms *= 0.9;
    }

    loop();
    launch();



  </script>




</body>
</html>